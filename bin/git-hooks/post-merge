#!/bin/sh
#
# Git hook to run "composer install" if the file "composer.lock" was changed.
#
# Notes:
# ------
#  - This hook is not executed by Eclipse.
#
#  - error: The hook is not executed if merging failed due to conflicts.
#  - error: The hook is not executed if you run pull with --rebase option.
#
#  - post-rewrite works for me. As side effect it is also executed on amend.
#    @see  http://stackoverflow.com/questions/21307744/git-post-rebase-hook
#
#  - I would check updated submodules too:
#    check_run .gitmodules "git submodule init && git submodule update"


# execute an existing user hook
if [ -x "$0.user" ]; then
    "$0.user" "$@" || exit $?
fi


# find Composer
result=$(type -P composer 2> /dev/null)
if [ -z "$result" ]; then
    result=$(type -P composer.phar 2> /dev/null)
    [ -z "$result" ] && echo "ERROR: could not find Composer" && exit 1
fi
if [[ ".$OSTYPE" = ".msys" || ".$OSTYPE" = ".cygwin" ]]; then
    # Windows/MinTTy: Use an existing alias which can fix color support issues.
    [ ".$TERM" != ".cygwin" ] && use_alias=1 
fi


# get the changed files
changed_files=$(git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD)


# check if composer.lock has changed and run Composer
check_run() {
    [ -f "$1" ]                                     && \
    echo "$changed_files" | grep --quiet -Fx "$1"   && \
    echo " * changes detected in $1"                && \
    echo " * running composer install"              && \
    {
    if [[ -n "$use_alias" && -f ~/.bash_aliases ]]; then
        shopt -s expand_aliases
        . ~/.bash_aliases
    fi
    eval "COMPOSER_ALLOW_SUPERUSER=1 composer install"
    }
}
check_run 'composer.lock'
