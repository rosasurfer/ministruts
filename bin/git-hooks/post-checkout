#!/usr/bin/bash
#
# Git hook to run "composer install" if the file "composer.lock" was changed.
#
# This hook is not executed by Eclipse.
#


# check for and execute an existing user hook
if [ -f "$0.user" ]; then
   "$0.user" "$@"
fi


# check and configure Composer
result=$(type -P composer.phar 2> /dev/null)
if [ ".$result" == "." ]; then
    result=$(type -P composer 2> /dev/null)
    [ ".$result" == "." ] && echo "ERROR: could not find Composer" && exit 1
fi
if [ ".$OSTYPE" = ".msys" ] || [ ".$OSTYPE" = ".cygwin" ] ; then
    if [ ".$BASH_VERSION" != "." ]; then
        # if running bash in msys or cygwin
        ansi='--ansi'
    fi
fi
COMPOSER_ALLOW_SUPERUSER=1


# get changed file names
changed_files=$(git diff-tree -r --name-only --no-commit-id $1 $2)


check_run() {
    [ -f "$1" ]                                     && \
    echo "$changed_files" | grep --quiet -Fx "$1"   && \
    echo " * changes detected in $1"                && \
    echo " * running $2"                            && \
    composer $ansi install
}


# run composer if lock file has changed
check_run 'composer.lock'
